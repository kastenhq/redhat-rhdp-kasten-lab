= Lab 2 - Configure Veeam Kasten
:toc:

====
[IMPORTANT]

If you have already configured an S3-compatible object store for Kasten and created a location profile in the previous Module, you can skip to <<create-policy>> using the Location Profile you created previously.
====

== 1. Configure an S3-compatible Object Store for Backup

Out of the box, Kasten provides everything required to perform a local snapshot of a Kubernetes application (It does require _k10.kasten.io/is-snapshot-class: "true"_ is set on the VolumeSnapshotClass, which has already been done when the lab was provisioned) - _but snapshots are not backup!_ In order to restore in the event the local cluster or primary storage is compromised, a copy of that data should be exported to another location.

The configuration of these backup targets are called *_Location Profiles_*.
Kasten https://docs.kasten.io/latest/usage/configuration.html[supports several options], including:

* AWS S3
* Azure Blob
* Google Cloud Storage
* S3-Compatible
* NFS
* Veeam Backup & Recovery

Kasten supports the creation of immutable backups to ensure that, as a last line of defense against ransomware, backup data cannot be manipulated or deleted by any user.
These backups are supported on the following platforms:

* AWS S3
* S3-Compatible with Object Lock support (ex.
Ceph, MinIO, Wasabi, etc.)
* Azure Blob
* Google Cloud Storage

'''

_In this exercise, you will configure a bucket using the on-cluster Ceph Object Gateway deployment and add the bucket as a Location Profile in Kasten._

====
[CAUTION]

In a real world environment you should never back up data to the same infrastructure you are intending to protect - using on-cluster storage as a backup target is performed in the lab solely to simplify lab staging and instructions.
====

== 2. Configuring an Object Bucket Claim to Store Backups

====
[NOTE]

Kasten supports immutable object storage and it is recommended to protect backups against accidental deletion or ransomware attack. For this lab, we won't configure immutability as it requires elevated permissions.
====

. If you haven't yet logged into the {openshift_console_url}[OpenShift console^] log into the console now.
.. Your UserID is `{user}` with password `{password}`.
. Open an OpenShift command line terminal
+
image::module01-lab02-location-profile/002.png[]

. An `ObjectBucketClaim` has already been created for you. You can examine the claim using the following command:
+
[source,bash,role=execute,subs="attributes"]
----
oc describe objectbucketclaim -n backuptarget-{user} kastenbackups-{user}
----

. Run the following command to retrieve the Access Key for the bucket:
+
[source,bash,role=execute,subs="attributes"]
----
oc get secret -n backuptarget-{user} kastenbackups-{user} \
  -o jsonpath='{.data.AWS_ACCESS_KEY_ID}' | base64 --decode && echo
----
+
Copy the Access Key to a text editor as it will be needed again shortly

. Run the following command to retrieve the Secret Key for the bucket:
+
[source,bash,role=execute,subs="attributes"]
----
oc get secret -n backuptarget-{user} kastenbackups-{user} \
 -o jsonpath='{.data.AWS_SECRET_ACCESS_KEY}' | base64 --decode && echo
----
+
Copy the Secret Key to a text editor as it will be needed again shortly.

== 3. Creating an S3-Compatible Location Profile

. In the *_Kasten Dashboard_*, select *_Profiles → Location_* from the sidebar and click *_+ Add New_*.
+
image::module01-lab02-location-profile/01.png[]

. Fill out the following fields and click *_Next_*:
+
|===
|  |

| *_Location Profile Name_*
| `kastenbackups-{user}`

| *_Storage Provider_*
| S3 Compatible
|===
+
image::module01-lab02-location-profile/02.png[]

. Fill out the following fields *_but DO NOT click Next yet!_*:
+
|===
|  |

| *_S3 Access Key_*
| Paste `ACCESS KEY` value

| *_S3 Secret_*
| Paste `SECRET KEY` value

| *_Endpoint_*
| `{kasten_backup_bucket_host}`

| *_Skip certificate chain and hostname verification_*
| `Checked`

| *_Region_*
| `us-east-1`

| *_Bucket_*
| `kastenbackups-{user}`
|===
+
image::module01-lab02-location-profile/02b.png[]

. Click *_Next_* followed by *_Submit_* to create the Location Profile.
+
You should expect your `kastenbackups-{user}` Location Profile to appear with a *_Success_* status.
+
image::module01-lab02-location-profile/05.png[]
+
Now you're ready to start protecting apps!

. Click the *_..._* menu and select *_View YAML_* to view the manifest generated by creating a Location Profile through the Dashboard.
+
image::module01-lab02-location-profile/06.png[]
+
As you can see from this example, Kasten Location Profiles can be created declaratively as a `profile.config.kio.kasten.io` object referencing a Secret to store access and secret keys.
This Kubernetes-native implementation makes it simple to configure backup targets using a GitOps approach.
+
====
[NOTE]

See https://docs.kasten.io/latest/api/profiles.html[docs.kasten.io] for complete documentation on defining Profile API objects.
====

. Click *_Cancel_* or the *_X_* in the upper-right to close the YAML window.


== 4. Creating a Kasten Policy [[create-policy]]

. In the *_Kasten Dashboard_*, select *_Applications_* to view all discovered namespaces.
+
image::module01-lab03-backup_restore/07.png[]
+
Your `kasten-lab-{user}-pacman` application should appear as *_Unmanaged_*, indicating it is not being protected by any policy.
+
====
[TIP]

You will notice that you don't see any namespaces starting with `openshift` in the list of applications.

Namespaces, including the `+openshift-...+` system namespaces can be excluded from the *_Applications_* list (and compliance reporting) by adding a list of `excludedApps` to the K10 Operand `spec`, as shown:

image::module01-lab03-backup_restore/08.png[]

The following command can be used to produce a properly formatted list of namespaces beginning with `openshift` that can be copy/paste into the K10 Operand YAML tab:

[source,bash,role=execute,subs="attributes"]
----
oc get ns --no-headers=true | \
  awk 'BEGIN { print "  excludedApps:" } /^openshift/{print "  -",$1}'
----

Your lab environment has already been configured to exclude system namespaces.
====

. Click `kasten-lab-{user}-pacman` in the *_Applications_* list to view details about the workloads and additional resources discovered within the namespace.
+
image::module01-lab03-backup_restore/09.png[]

. Close the *_Application Details_* window.
. Under `kasten-lab-{user}-pacman`, select *_...
→ Create a Policy_*.
+
image::module01-lab03-backup_restore/10.png[]

. Leave the defaults for *_Name_* and *_Action_*.
+
image::module01-lab03-backup_restore/11.png[]
+
====
[NOTE]

Policy Presets provide the option of allowing administrators to define SLA-focused configurations to simplify self-service data protection for other users.
====

. Leave the default *_Hourly Backup Frequency_* and *_Snapshot Retention_* values.
+
image::module01-lab03-backup_restore/12.png[]
+
====
[NOTE]

- Toggling *_Advanced Frequency Options_* allows users to specify what time hourly snapshots occur, how many snapshots to take per hour, and which snapshots should be used for daily, weekly, monthly, and yearly promotion.
- Toggling *_Backup Window_* allows users to specify during what times is Kasten allowed to run the policy.
- Enabling *_Use Staggering_* can intelligently distribute when to start policies during the specified window such that the desired frequency is maintained, but with the least amount of policies running simultaneously, allowing Kasten to reduce the peak load on the cluster.
- These settings should be left unselected for this lab.
====

. Toggle *_Enable Backups via Snapshot Exports_* and select `kastenbackups-{user}` as the *_Export Location Profile_*.
+
image::module01-lab03-backup_restore/13.png[]
+
====
[NOTE]

By default, Kasten will export all data associated with the snapshot to ensure you have a durable, off-cluster copy.
However, there are circumstances where you may only want to export references to the snapshot, such as migrating a workload in AWS from one availability zone to another.
This ability to only export snapshot metadata can dramatically improve performance in these specific instances.
This can be configured under *_Advanced Export Settings_*.
====

. Under *_Select Applications_*, verify the `kasten-lab-{user}-pacman` namespace has been selected.
+
image::module01-lab03-backup_restore/14.png[]
+
====
[NOTE]

Targeting application(s) based on namespace is generally the most straightforward method of defining a backup policy.
However, Kasten also allows you to identify applications based on native Kubernetes labels.
This is especially helpful if you have many VMs in a single namespace and only want to protect current and *_future_* VMs with a specific label on the `VirtualMachine` resource, such as `backup: gold` or `vm: prod`.

Kasten also provides rich filtering capabilities to include or exclude resources based on Kubernetes *_API Group_*, *_API Version_*, *_Resource Type_*, *_Resource Name_*, and *_Labels_*.
For example, you could exclude backup for *_Secrets_* resources where a label includes an indication that the secret is externally managed.
====

. Leave the remaining settings as default.
+
====
[TIP]

When performing many tasks within the Kasten UI, you can press the *_</> YAML_* button to expose the native Kubernetes YAML that defines the resource created through the UI.
This can be useful for familiarizing yourself with the Kubernetes-native APIs defined by Kasten and for extracting snippets for use in GitOps or Infrastructure-as-Code tools.
====

. Click *_Create Policy_*.